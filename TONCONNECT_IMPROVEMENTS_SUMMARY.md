# –†–µ–∑—é–º–µ —É–ª—É—á—à–µ–Ω–∏–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ TonConnect

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ 1. –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `tonconnect_validator.go`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å —ç–º–æ–¥–∑–∏-–ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (payload, signature, wallet address)
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏—á–∏–Ω–∞–º–∏:
  - "Expired timestamp" - –∏—Å—Ç–µ–∫—à–∞—è –ø–æ–¥–ø–∏—Å—å
  - "Invalid signature" - –Ω–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å
  - "Public key not found" - –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω
  - "Address mismatch" - –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:**
```
üîê TonConnect validation started for wallet: EQ...
üì¶ Payload received: {"nonce":"...","timestamp":...}
‚úçÔ∏è  Signature received (first 20 chars): abc123...
‚úÖ Payload parsed successfully
‚è∞ Timestamp validation: now=..., payload_timestamp=..., age=...
‚úÖ Signature decoded (base64): length=64 bytes
üîë Using public key from frontend
‚úÖ Public key from frontend: abc123... (first 16 chars)
üîê Message hash computed: def456... (first 16 chars)
üîç Verifying Ed25519 signature...
‚úÖ TonConnect signature validated successfully
```

### ‚úÖ 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è `public_key` –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: frontend > TON API
- Fallback –Ω–∞ TON API, –µ—Å–ª–∏ –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω

**Backend –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```go
func (v *TonConnectValidator) ValidateSignature(
    ...
    publicKeyHex string, // –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
) error
```

**Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ publicKey –∏–∑:
  1. `signResult.publicKey` (TonConnect v2)
  2. `tonConnectUI.account.publicKey` (TonConnect UI)
  3. `connector.wallet.account.publicKey` (fallback)
- –û—Ç–ø—Ä–∞–≤–∫–∞ `public_key` –≤ –∑–∞–ø—Ä–æ—Å–µ, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω

### ‚úÖ 3. –£–≤–µ–ª–∏—á–µ–Ω–æ –æ–∫–Ω–æ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ timestamp

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
- **–ë—ã–ª–æ:** 10 –º–∏–Ω—É—Ç
- **–°—Ç–∞–ª–æ:** 20 –º–∏–Ω—É—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ —Å–µ—Ç–∏.

**–ö–æ–¥:**
```go
validator.ValidateSignature(ctx, walletAddress, req.Signature, req.Payload, 20*time.Minute, req.PublicKey)
```

### ‚úÖ 4. –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (Development Mode)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `SKIP_AUTH_VALIDATION`
- –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ `"true"`, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º ‚ö†Ô∏è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –í .env –∏–ª–∏ docker-compose.yml
SKIP_AUTH_VALIDATION=true
```

**–í–∞–∂–Ω–æ:** –¢–æ–ª—å–∫–æ –¥–ª—è development –æ–∫—Ä—É–∂–µ–Ω–∏—è!

### ‚úÖ 5. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ 401 –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
- –í—ã–≤–æ–¥ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–∫–∏ –∏ –¥–µ—Ç–∞–ª–µ–π –æ—Ç –±—ç–∫–µ–Ω–¥–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø—Ä–æ—Å–µ (payload, signature, public_key)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ JSON –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏:**
```javascript
üîê Authentication Error: signature validation failed: Invalid signature
üìã Error Details: Invalid signature: Ed25519 verification failed
üì¶ Request Payload: {
  wallet_address: "EQ...",
  payload: "...",
  has_signature: true,
  has_public_key: true
}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### Backend —Ñ–∞–π–ª—ã:
1. `backend/internal/services/tonconnect_validator.go`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `publicKeyHex`
   - –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

2. `backend/internal/api/routes_user.go`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `PublicKey` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–ø—Ä–æ—Å–∞
   - –£–≤–µ–ª–∏—á–µ–Ω–æ –æ–∫–Ω–æ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–æ 20 –º–∏–Ω—É—Ç
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –¥–µ—Ç–∞–ª—è–º–∏

### Frontend —Ñ–∞–π–ª—ã:
1. `frontend/src/components/WalletConnect.tsx`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ publicKey –∏–∑ TonConnect
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ public_key –≤ –∑–∞–ø—Ä–æ—Å–µ
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 401
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç publicKey –æ—Ç TonConnect
2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç publicKey –≤ –∑–∞–ø—Ä–æ—Å–µ
3. Backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç publicKey –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–±—ã—Å—Ç—Ä–µ–µ, —á–µ–º TON API)
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ

### –°—Ü–µ–Ω–∞—Ä–∏–π —Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º TON API:
1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å publicKey
2. Backend –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ TON API
3. –ï—Å–ª–∏ TON API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SKIP_AUTH_VALIDATION=true`

### –°—Ü–µ–Ω–∞—Ä–∏–π —Å –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å—å—é:
1. Backend –ª–æ–≥–∏—Ä—É–µ—Ç: "‚ùå Expired timestamp: age 25m0s exceeds maximum 20m0s"
2. Frontend –ø–æ–ª—É—á–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª–∏

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤ –ª–æ–≥–∞—Ö:
- ‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚ùå –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏
- üîë –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π (frontend vs TON API)
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:**
- `SKIP_AUTH_VALIDATION=true` —Ç–æ–ª—å–∫–æ –¥–ª—è development
- –í production –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –ü—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å—É –∫–æ—à–µ–ª—å–∫–∞

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã:
- `TONCONNECT_DEBUGGING_GUIDE.md` - –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ç–ª–∞–¥–∫–µ
- `TONCONNECT_IMPROVEMENTS_SUMMARY.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª
