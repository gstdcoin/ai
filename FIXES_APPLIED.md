# Исправления проблем с падением платформы

## Проблемы, которые были исправлены

### 1. DNS конфигурация (КРИТИЧНО)
**Проблема:** Контейнеры использовали внешние DNS серверы (8.8.8.8, 1.1.1.1) вместо внутреннего Docker DNS, что вызывало таймауты при резолвинге имен сервисов (postgres, redis, frontend, backend).

**Решение:**
- Удалены внешние DNS серверы из `docker-compose.prod.yml`
- Теперь используется внутренний Docker DNS (127.0.0.11) для автоматического резолвинга имен сервисов

**Файлы:**
- `/home/ubuntu/docker-compose.prod.yml` - удалены секции `dns` и `dns_search`

### 2. Обработка ошибок подключения к БД и Redis
**Проблема:** Backend падал сразу при ошибке подключения к базе данных или Redis, без попыток повторного подключения.

**Решение:**
- Добавлена логика повторных попыток подключения (до 5 попыток с задержкой 5 секунд)
- Backend теперь более устойчив к временным сетевым проблемам

**Файлы:**
- `/home/ubuntu/backend/main.go` - добавлена retry логика для DB и Redis

### 3. Обработка ошибок TON API
**Проблема:** PaymentWatcher получал 404 ошибки от TON API, что могло вызывать проблемы.

**Решение:**
- Улучшена обработка 404 ошибок - они теперь не считаются критическими
- Добавлено логирование для лучшей диагностики

**Файлы:**
- `/home/ubuntu/backend/internal/services/payment_watcher.go` - улучшена обработка ошибок

### 4. Конфигурация .env файла
**Проблема:** Backend не мог найти .env файл в контейнере.

**Решение:**
- Добавлен `env_file: .env` в `docker-compose.yml` для backend
- Переменные окружения теперь правильно загружаются

**Файлы:**
- `/home/ubuntu/docker-compose.yml` - добавлен `env_file: .env`

## Мониторинг

Создан скрипт мониторинга `/home/ubuntu/monitor.sh` для автоматической проверки состояния контейнеров.

### Использование:
```bash
# Ручной запуск
./monitor.sh

# Добавить в crontab для автоматического мониторинга каждые 5 минут
*/5 * * * * /home/ubuntu/monitor.sh
```

## Рекомендации

1. **Настройте автоматический мониторинг** через cron или systemd timer
2. **Проверьте логи регулярно**: `docker logs ubuntu_backend_1 --tail 50`
3. **Мониторинг ресурсов**: `docker stats` для проверки использования памяти/CPU
4. **Настройте алерты** при превышении лимитов памяти или частых перезапусках

## Проверка работоспособности

После применения исправлений проверьте:
```bash
# Статус всех контейнеров
docker-compose ps

# Логи backend
docker logs ubuntu_backend_1 --tail 20

# Доступность сайта
curl -I https://app.gstdtoken.com/

# Проверка DNS резолвинга внутри контейнера
docker exec ubuntu_backend_1 nslookup postgres
```

## Дополнительные улучшения

Для еще большей стабильности рекомендуется:
1. Настроить health checks для всех сервисов
2. Добавить автоматическое масштабирование при высокой нагрузке
3. Настроить логирование в централизованную систему (ELK, Loki)
4. Добавить метрики (Prometheus + Grafana)

