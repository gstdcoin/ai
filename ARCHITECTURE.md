# Архитектура платформы распределённых вычислений

## 1. ОБЩАЯ АРХИТЕКТУРА СИСТЕМЫ

### 1.1 Компоненты системы

```
┌─────────────────┐
│   Заказчик      │
│  (GSTD token)   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│      Сервер-оркестратор             │
│  ┌───────────────────────────────┐  │
│  │ Task Queue Manager            │  │
│  │ Device Matcher                │  │
│  │ Result Validator              │  │
│  │ Payment Initiator              │  │
│  └───────────────────────────────┘  │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────┐
│  TON Blockchain │
│  (Smart Contract)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Исполнитель   │
│ (Mobile Device) │
└─────────────────┘
```

### 1.2 Принципы проектирования

- **Минимализм**: только необходимые компоненты
- **Декомпозиция**: каждый модуль решает одну задачу
- **Безопасность**: zero-trust между компонентами
- **Эффективность**: минимум накладных расходов

---

## 2. СЕРВЕРНЫЕ МОДУЛИ

### 2.1 Task Queue Manager

**Ответственность:**
- Приём заданий от заказчиков
- Валидация JSON-дескриптора
- Приоритизация по формуле
- Управление очередью

**Входные данные:**
```json
{
  "task_id": "uuid-v4",
  "task_type": "inference|human|validation|agent",
  "operation": "whitelisted_operation",
  "model": "whitelisted_model",
  "input": {
    "source": "ipfs|http|inline",
    "hash": "string"
  },
  "constraints": {
    "time_limit_sec": 1-5,
    "max_energy_mwh": 1-50
  },
  "reward": {
    "amount_ton": "decimal"
  },
  "validation": "reference|majority|ai_check|human"
}
```

**Валидация:**
1. Проверка whitelist операций
2. Проверка whitelist моделей
3. Проверка лимитов (time, energy)
4. Проверка escrow баланса заказчика
5. Проверка наличия GSTD токена на кошельке заказчика

**Приоритизация:**
```
priority_score = (
  gstd_balance * balance_weight +
  reward_amount * reward_weight +
  task_urgency * urgency_weight +
  requester_reputation * rep_weight
) / normalization_factor
```

### 2.2 Device Matcher

**Ответственность:**
- Выбор оптимального устройства
- Учёт репутации устройства
- Учёт доступности ресурсов
- Балансировка нагрузки

**Критерии выбора:**
```
device_score = (
  device_reputation * rep_weight +
  available_energy * energy_weight +
  network_latency * latency_weight +
  cached_models * cache_weight -
  current_load * load_penalty
)
```

**Репутация устройства:**
```
reputation = (
  successful_tasks * success_rate +
  validation_passes * validation_rate -
  failed_tasks * failure_penalty -
  slashing_events * slash_penalty
) / total_tasks
```

### 2.3 Result Validator

**Ответственность:**
- Валидация результатов выполнения
- Выбор метода валидации
- Инициация cross-check при необходимости
- Фиксация результата

**Методы валидации:**

1. **Reference validation** (для детерминированных задач):
   - Сравнение с эталоном
   - Допустимая погрешность: ±0.01%

2. **Majority vote** (для субъективных задач):
   - Минимум 3 устройства
   - Консенсус: ≥66% совпадений

3. **AI-check** (для сложных задач):
   - Проверка результата более мощной моделью
   - Порог уверенности: ≥0.95

4. **Human validation** (для критических задач):
   - Ручная проверка заказчиком
   - Таймаут: 24 часа

**Формула стоимости валидации:**
```
validation_cost = (
  base_cost +
  (majority_count - 1) * additional_device_cost +
  ai_check_cost * ai_check_flag +
  human_check_cost * human_check_flag
)
```

### 2.4 Payment Initiator

**Ответственность:**
- Формирование транзакции выплаты
- Подпись серверным ключом
- Отправка в TON смарт-контракт
- Логирование транзакций

**Процесс выплаты:**
1. Получение подтверждения валидации
2. Формирование payment message
3. Подпись серверным ключом
4. Отправка в контракт
5. Ожидание подтверждения блокчейна

---

## 3. ПОТОК ДАННЫХ (STEP-BY-STEP)

### 3.1 Создание задания

```
1. Заказчик проверяет наличие GSTD токена на кошельке
   └─> TON Smart Contract: check_gstd_balance(address)

2. Заказчик вносит TON в escrow
   └─> TON Smart Contract: deposit_escrow(task_id, amount_ton)

3. Заказчик отправляет JSON-дескриптор на сервер
   └─> POST /api/v1/tasks
   └─> Headers: Authorization: Bearer <wallet_signature>

4. Task Queue Manager валидирует:
   ├─> Проверка whitelist операций
   ├─> Проверка whitelist моделей
   ├─> Проверка escrow баланса
   ├─> Проверка наличия GSTD токена
   └─> Проверка лимитов

5. При успешной валидации:
   └─> Задание добавляется в очередь с priority_score
```

### 3.2 Выполнение задания

```
1. Device Matcher выбирает устройство:
   ├─> Запрос доступных устройств
   ├─> Расчёт device_score для каждого
   └─> Выбор устройства с максимальным score

2. Сервер отправляет задание устройству:
   └─> POST /device/task
   └─> Body: JSON-дескриптор задания

3. Устройство:
   ├─> Загружает данные (IPFS/HTTP)
   ├─> Загружает модель (если нет в кэше)
   ├─> Выполняет операцию
   ├─> Формирует результат
   └─> Создаёт Proof-of-Execution

4. Устройство отправляет результат:
   └─> POST /device/result
   └─> Body: {
         "task_id": "uuid",
         "result": {...},
         "proof": {
           "device_id": "fingerprint",
           "timestamp": "unix",
           "signature": "wallet_signature",
           "energy_consumed": "mwh",
           "execution_time": "ms"
         }
       }

5. Result Validator валидирует:
   ├─> Проверка подписи устройства
   ├─> Проверка временных меток
   ├─> Применение метода валидации
   └─> Формирование validation_result

6. При успешной валидации:
   └─> Payment Initiator инициирует выплату
```

### 3.3 Выплата награды

```
1. Payment Initiator формирует транзакцию:
   └─> TON Smart Contract: execute_payment(
         task_id,
         device_address,
         amount_ton,
         validation_proof
       )

2. Смарт-контракт проверяет:
   ├─> Существование задания
   ├─> Статус валидации
   ├─> Достаточность escrow
   └─> Отсутствие двойной выплаты

3. При успешной проверке:
   ├─> Перевод TON на адрес устройства
   ├─> Обновление репутации устройства (+)
   ├─> Обновление репутации заказчика (+)
   └─> Фиксация события в блокчейне

4. Сервер обновляет локальное состояние:
   ├─> Отметка задания как выполненного
   ├─> Обновление статистики устройства
   └─> Уведомление заказчика
```

### 3.4 Обработка ошибок

```
Сценарий 1: Устройство не ответило
├─> Таймаут: time_limit_sec + 2 секунды
├─> Задание возвращается в очередь
├─> Репутация устройства снижается (-)
└─> Выбор нового устройства

Сценарий 2: Результат не прошёл валидацию
├─> Если validation = "majority":
│   └─> Задание отправляется другому устройству
├─> Если validation = "reference":
│   └─> Репутация устройства снижается (-)
└─> Задание возвращается в очередь

Сценарий 3: Устройство отправило невалидный proof
├─> Немедленное снижение репутации (-)
├─> Возможный slashing (при повторных нарушениях)
└─> Задание возвращается в очередь
```

---

## 4. ФОРМУЛЫ ПРИОРИТИЗАЦИИ И НАГРАД

### 4.1 Приоритизация заданий

```
priority_score = (
  gstd_balance * 0.4 +
  reward_amount_ton * 0.3 +
  task_urgency * 0.2 +
  requester_reputation * 0.1
) / normalization_factor

где:
- gstd_balance: баланс GSTD токена на кошельке (нормализовано 0-1)
- reward_amount_ton: размер награды в TON (нормализовано 0-1)
- task_urgency: срочность (0-1, вычисляется по deadline)
- requester_reputation: репутация заказчика (0-1)
- normalization_factor: константа для приведения к 0-1
```

### 4.2 Расчёт награды исполнителю

```
base_reward = task.reward.amount_ton

energy_bonus = (
  (max_energy_mwh - actual_energy_mwh) / max_energy_mwh
) * energy_bonus_rate * base_reward

time_bonus = (
  (time_limit_sec - actual_time_sec) / time_limit_sec
) * time_bonus_rate * base_reward

reputation_multiplier = 1.0 + (device_reputation - 0.5) * 0.2

final_reward = (
  base_reward +
  energy_bonus +
  time_bonus
) * reputation_multiplier
```

### 4.3 Slashing механизм

```
slashing_conditions = [
  "invalid_proof",
  "repeated_failures",
  "malicious_behavior",
  "consensus_violation"
]

slashing_amount = (
  base_slashing * severity_multiplier * repetition_multiplier
)

где:
- base_slashing: базовая сумма штрафа (в GSTD)
- severity_multiplier: 1.0 (minor) до 5.0 (critical)
- repetition_multiplier: 1.0 (first) до 10.0 (repeated)
```

### 4.4 Репутационная система

**Репутация устройства:**
```
device_reputation = (
  successful_tasks / total_tasks * 0.5 +
  validation_passes / total_validations * 0.3 +
  average_response_time_score * 0.1 +
  energy_efficiency_score * 0.1
) - slashing_penalty

где:
- average_response_time_score: нормализованная скорость (0-1)
- energy_efficiency_score: нормализованная эффективность (0-1)
- slashing_penalty: накопленные штрафы (0-0.5)
```

**Репутация заказчика:**
```
requester_reputation = (
  completed_tasks / total_created_tasks * 0.6 +
  average_validation_success_rate * 0.3 +
  timely_payments * 0.1
)
```

---

## 5. ЭКОНОМИЧЕСКАЯ ЭФФЕКТИВНОСТЬ

### 5.1 Сравнение с облачными провайдерами

**Облачные провайдеры:**
- Стоимость: $0.0001-0.001 за секунду GPU
- Минимальная единица: 1 минута
- Накладные расходы: 20-30%

**Наша система:**
- Стоимость: 0.01-0.05 TON за задание (5 секунд)
- Минимальная единица: 1 секунда
- Накладные расходы: 5-10%

**Экономия:**
```
cloud_cost_per_second = $0.0005
our_cost_per_second = 0.01 TON / 5 = 0.002 TON

При курсе 1 TON = $2:
our_cost_per_second = $0.004

Экономия: 20% от облачных решений
```

### 5.2 Масштабирование

**Горизонтальное масштабирование:**
- Каждое устройство независимо
- Нет узких мест в вычислениях
- Линейное масштабирование с ростом устройств

**Вертикальное масштабирование:**
- Сервер только оркестрирует
- Не требует GPU/CPU для вычислений
- Масштабируется по сети и памяти

### 5.3 Оптимизация затрат

**Кэширование моделей:**
- Устройство кэширует модели локально
- Экономия: 80-90% трафика
- Ускорение: 2-3x

**Батчинг заданий:**
- Группировка похожих заданий
- Экономия на валидации
- Снижение накладных расходов на 30-40%

**Репутационная фильтрация:**
- Приоритет надёжным устройствам
- Снижение повторных выполнений на 60-70%
- Экономия на валидации

---

## 6. ЮРИДИЧЕСКАЯ НЕЙТРАЛЬНОСТЬ

### 6.1 Модель токенов

**GSTD:**
- Утилитарный токен (utility token)
- Не является ценной бумагой
- Используется только для доступа к системе
- Не имеет денежной стоимости в системе

**TON:**
- Платёжное средство
- Используется только для наград
- Не связано с управлением системой
- Соответствует существующему законодательству

### 6.2 Разделение ответственности

**Сервер:**
- Только оркестрация
- Не выполняет вычисления
- Не хранит приватные ключи
- Не контролирует результаты

**Устройство:**
- Самостоятельное выполнение
- Контроль над данными
- Подпись результатов
- Ответственность за результат

**Блокчейн:**
- Прозрачность транзакций
- Неизменяемость записей
- Децентрализованная валидация

### 6.3 Соответствие требованиям

- **GDPR**: данные не хранятся централизованно
- **KYC**: не требуется для исполнителей
- **AML**: прозрачность через блокчейн
- **Securities law**: GSTD не является ценной бумагой

---

## 7. ПРЕИМУЩЕСТВА ПЕРЕД BOINC

### 7.1 Технические преимущества

**BOINC:**
- Задания: минуты-часы
- Валидация: только majority vote
- Награды: только репутация
- Устройства: только десктопы

**Наша система:**
- Задания: секунды (≤5 сек)
- Валидация: 4 метода (reference, majority, AI, human)
- Награды: TON (реальная ценность)
- Устройства: мобильные + десктопы

### 7.2 Экономические преимущества

**BOINC:**
- Нет монетизации для исполнителей
- Нет стимула для быстрого выполнения
- Нет контроля качества

**Наша система:**
- Монетизация через TON
- Стимул через репутацию и бонусы
- Контроль качества через валидацию

### 7.3 Практические преимущества

**BOINC:**
- Требует установки клиента
- Требует настройки
- Не подходит для мобильных

**Наша система:**
- Простая интеграция (API)
- Автоматическая настройка
- Оптимизация для мобильных

---

## 8. БЕЗОПАСНОСТЬ

### 8.1 Защита от атак

**Sybil атаки:**
- Device fingerprinting
- Репутационная система
- Slashing механизм

**Replay атаки:**
- Уникальные task_id
- Временные метки
- Nonce в proof

**Man-in-the-middle:**
- TLS для всех соединений
- Подпись результатов кошельком
- Проверка подписей на сервере

### 8.2 Изоляция выполнения

**Устройство:**
- Sandbox для выполнения
- Нет доступа к ОС
- Нет доступа к сети (кроме загрузки данных)
- Ограничение ресурсов

**Сервер:**
- Нет доступа к приватным ключам
- Нет доступа к данным заданий
- Только оркестрация

### 8.3 Аудит и прозрачность

**Блокчейн:**
- Все выплаты прозрачны
- Все события фиксируются
- Невозможность подделки

**Логирование:**
- Все операции логируются
- Аудит доступен заказчикам
- Соответствие требованиям

---

## 9. МАСШТАБИРУЕМОСТЬ

### 9.1 Архитектурные решения

**Микросервисная архитектура:**
- Независимые модули
- Горизонтальное масштабирование
- Изоляция отказов

**Асинхронная обработка:**
- Очереди заданий
- Асинхронная валидация
- Неблокирующие выплаты

**Кэширование:**
- Кэш моделей на устройствах
- Кэш результатов валидации
- Кэш репутации

### 9.2 Производительность

**Целевые метрики:**
- Пропускная способность: 10,000 заданий/сек
- Задержка: <100ms (от создания до выполнения)
- Доступность: 99.9%

**Оптимизации:**
- Батчинг заданий
- Предзагрузка моделей
- Предварительная валидация

---

## 10. РЕАЛИЗАЦИЯ

### 10.1 Технологический стек

**Сервер:**
- Язык: Go (производительность, простота)
- База данных: PostgreSQL (транзакции, надёжность)
- Очереди: Redis (скорость, простота)
- Блокчейн: TON SDK

**Устройство:**
- Язык: Kotlin (Android), Swift (iOS)
- ML Framework: TensorFlow Lite, Core ML
- Блокчейн: TON SDK

**Смарт-контракт:**
- Язык: FunC
- Функции: escrow, payment, reputation

### 10.2 Этапы разработки

**Фаза 1: MVP (2-3 месяца)**
- Базовый сервер-оркестратор
- Простой клиент для устройств
- Базовый смарт-контракт
- Поддержка 2-3 типов заданий

**Фаза 2: Масштабирование (3-4 месяца)**
- Оптимизация производительности
- Расширение типов заданий
- Улучшение валидации
- Репутационная система

**Фаза 3: Продакшн (2-3 месяца)**
- Аудит безопасности
- Нагрузочное тестирование
- Документация
- Запуск

---

## ЗАКЛЮЧЕНИЕ

Система спроектирована как минималистичная, эффективная и безопасная платформа распределённых вычислений. Все компоненты логически связаны и работают как единое целое. Экономическая модель обеспечивает стимулы для всех участников, а техническая архитектура гарантирует масштабируемость и надёжность.

