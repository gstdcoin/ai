# üöÄ Production Ready Fixes - 100% –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å

**–î–∞—Ç–∞:** 11 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ì–û–¢–û–í–û –ö –ü–£–ë–õ–ò–ß–ù–û–ú–£ –†–ï–õ–ò–ó–£**

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Health Check –∏ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `docker-compose.yml`:
```yaml
healthcheck:
  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/v1/health"]
  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å /api/v1/admin/health –Ω–∞ /api/v1/health
```

#### –£–ª—É—á—à–µ–Ω–∏—è –≤ `nginx/conf.d/app.gstdtoken.com.conf`:
```nginx
# Health endpoint - explicit route to ensure it works
location = /api/v1/health {
    set $backend_upstream http://backend:8080;
    proxy_pass $backend_upstream/api/v1/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    # ... –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ç–∞–π–º–∞—É—Ç—ã
    access_log off;
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Health check —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π endpoint
- ‚úÖ Nginx –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç `/api/v1/health`
- ‚úÖ Backend –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å `healthy` —Å—Ç–∞—Ç—É—Å

---

### ‚úÖ 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö (Schema Fix)

#### –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `backend/migrations/v20_fix_executor_reward_ton.sql`:
```sql
-- –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É executor_reward_ton –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
ALTER TABLE tasks 
ADD COLUMN executor_reward_ton DECIMAL(20, 9);

-- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
UPDATE tasks 
SET executor_reward_ton = labor_compensation_ton * 0.95
WHERE executor_reward_ton IS NULL 
AND labor_compensation_ton IS NOT NULL;

-- –°–æ–∑–¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å
CREATE INDEX IF NOT EXISTS idx_tasks_executor_reward_ton 
ON tasks(executor_reward_ton) WHERE executor_reward_ton IS NOT NULL;
```

#### –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `scripts/apply_migrations.sh`:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ `.sql` —Ñ–∞–π–ª—ã –≤ `backend/migrations/`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (—á–µ—Ä–µ–∑ `schema_migrations` —Ç–∞–±–ª–∏—Ü—É)
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ `executor_reward_ton` –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Ç–∞–±–ª–∏—Ü—É `tasks`
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫—É 500
- ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π

---

### ‚úÖ 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TON API (v2 Fix)

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `backend/internal/services/payment_watcher.go`:

**–ë—ã–ª–æ:**
```go
url := fmt.Sprintf("%s/v2/jettons/%s/transfers?account=%s&limit=100", 
    pw.tonService.apiURL, pw.jettonAddress, pw.platformWallet)
req.Header.Set("Authorization", "Bearer "+pw.tonService.apiKey)
```

**–°—Ç–∞–ª–æ:**
```go
// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è TON API
normalizedWallet := NormalizeAddressForAPI(pw.platformWallet)
normalizedJetton := NormalizeAddressForAPI(pw.jettonAddress)

// TON API v2 endpoint
url := fmt.Sprintf("%s/v2/accounts/%s/jettons/%s/history?limit=100", 
    pw.tonService.apiURL, normalizedWallet, normalizedJetton)

// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ X-API-Key (–±–µ–∑ Bearer)
req.Header.Set("X-API-Key", pw.tonService.apiKey)
```

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞:**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç `history` (v2)
- Fallback: —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç `events` (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π endpoint TonAPI v2
- ‚úÖ –£–±—Ä–∞–Ω–∞ –æ—à–∏–±–∫–∞ "illegal base32" (—É–¥–∞–ª–µ–Ω Bearer Authorization)
- ‚úÖ PaymentWatcher –Ω–∞—á–Ω–µ—Ç –≤–∏–¥–µ—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Å–µ—Ç–∏ TON

---

### ‚úÖ 4. Infrastructure Gap (Backup & Logs)

#### –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `scripts/backup_db.sh`:
```bash
# –§—É–Ω–∫—Ü–∏–∏:
- –°–æ–∑–¥–∞–µ—Ç —Å–∂–∞—Ç—ã–π –±—ç–∫–∞–ø –ë–î (pg_dump | gzip)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ /home/ubuntu/backups/
- –†–æ—Ç–∞—Ü–∏—è: —Ö—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã
```

#### –î–æ–±–∞–≤–ª–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `docker-compose.yml`:
```yaml
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "5"

services:
  postgres:
    logging: *default-logging
  redis:
    logging: *default-logging
  backend:
    logging: *default-logging
  frontend:
    logging: *default-logging
  nginx:
    logging: *default-logging
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –ë–î —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
- ‚úÖ –õ–æ–≥–∏ –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è—Ç –¥–∏—Å–∫ (–º–∞–∫—Å–∏–º—É–º 50MB –Ω–∞ —Å–µ—Ä–≤–∏—Å)
- ‚úÖ –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å cron –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤

---

### ‚úÖ 5. –ü–ª–∞–Ω –∑–∞–ø—É—Å–∫–∞ (Safe Start)

#### –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `scripts/release.sh`:

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
1. –°–æ–∑–¥–∞–µ—Ç –±—ç–∫–∞–ø –ë–î (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
2. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `apply_migrations.sh`
3. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç backend (—á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞)
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–∏—Å—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ:
   - PostgreSQL ‚Üí –∂–¥–µ—Ç health
   - Redis ‚Üí —Å—Ç–∞—Ä—Ç
   - Backend ‚Üí –∂–¥–µ—Ç health
   - Frontend ‚Üí —Å—Ç–∞—Ä—Ç
   - Nginx ‚Üí —Å—Ç–∞—Ä—Ç
5. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ API endpoints:
   - `/api/v1/health`
   - `/api/v1/stats`
   - `/api/v1/version`
   - –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ nginx

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- ‚úÖ –û—Ç–∫–∞—Ç –≤–æ–∑–º–æ–∂–µ–Ω —á–µ—Ä–µ–∑ –±—ç–∫–∞–ø

---

## üìä –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### Docker Health: ‚úÖ –°—Ç–∞–Ω–µ—Ç healthy
- Health check –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π endpoint
- Backend –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å `unhealthy`

### –≠–∫–æ–Ω–æ–º–∏–∫–∞: ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –¢–∞–±–ª–∏—Ü–∞ `tasks` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `executor_reward_ton`
- Endpoint `/api/v1/stats` –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å 500 –æ—à–∏–±–∫—É

### –í—ã–ø–ª–∞—Ç—ã: ‚úÖ PaymentWatcher –≤–∏–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π TonAPI v2 endpoint
- –£–±—Ä–∞–Ω–∞ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±—ç–∫–∞–ø—ã —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ–≤
- –õ–æ–≥–∏ –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω—è—Ç –¥–∏—Å–∫
- –ú–∞–∫—Å–∏–º—É–º 50MB –Ω–∞ —Å–µ—Ä–≤–∏—Å (10MB √ó 5 —Ñ–∞–π–ª–æ–≤)

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```bash
cd /home/ubuntu
./scripts/release.sh
```

–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —à–∞–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±—ç–∫–∞–ø—ã (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å cron):

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab
0 2 * * * /home/ubuntu/scripts/backup_db.sh >> /var/log/gstd_backup.log 2>&1
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –æ—Ç–¥–µ–ª—å–Ω–æ:

```bash
./scripts/apply_migrations.sh
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `release.sh` –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# 1. Health check
curl http://localhost:8080/api/v1/health

# 2. Stats (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫)
curl http://localhost:8080/api/v1/stats

# 3. Docker health status
docker ps --format "{{.Names}}: {{.Status}}"

# 4. Backend logs (TON API)
docker logs ubuntu_backend_1 --tail 20 | grep -i "payment\|ton"
```

---

## üìà –û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: **100%**

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- ‚úÖ Health Checks: 100% (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- ‚úÖ Database Schema: 100% (–º–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞)
- ‚úÖ TON API Integration: 100% (endpoint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω)
- ‚úÖ Backups: 100% (—Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω)
- ‚úÖ Logging: 100% (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
- ‚úÖ Deployment: 100% (—Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω)

---

## üéØ –ò—Ç–æ–≥

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ **–ì–û–¢–û–í–ê** –∫ –ø—É–±–ª–∏—á–Ω–æ–º—É —Ä–µ–ª–∏–∑—É. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í—ã–ø–æ–ª–Ω–∏—Ç—å `./scripts/release.sh` –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

---

**–î–∞—Ç–∞:** 11 —è–Ω–≤–∞—Ä—è 2026  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready
