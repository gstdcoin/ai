# Система контроля версий образов

## Проблема

Образ фронтенда был собран 27 декабря 2025, но код обновлялся 4 января 2026. Это привело к использованию устаревшего образа с новым кодом.

## Причины

1. **Отсутствие автоматической пересборки** - образы не пересобирались автоматически при изменении кода
2. **Использование кэша Docker** - старые образы использовались из кэша
3. **Отсутствие проверки актуальности** - не было механизма проверки соответствия образа и кода

## Решение

### 1. Скрипты автоматической проверки и пересборки

#### `check-image-freshness.sh`
Проверяет, актуальны ли образы по сравнению с исходным кодом:
```bash
/home/ubuntu/scripts/check-image-freshness.sh
```

#### `rebuild-frontend.sh`
Пересобирает фронтенд, если код новее образа:
```bash
/home/ubuntu/scripts/rebuild-frontend.sh
/home/ubuntu/scripts/rebuild-frontend.sh --force  # Принудительная пересборка
```

#### `auto-rebuild.sh`
Автоматически проверяет и пересобирает устаревшие образы:
```bash
/home/ubuntu/scripts/auto-rebuild.sh
```

### 2. Интеграция в мониторинг

- **Health Check**: Проверяет актуальность образов каждые 5 минут
- **Auto-Recovery**: Автоматически пересобирает устаревшие образы каждые 15 минут
- **Auto-Rebuild**: Автоматическая проверка и пересборка каждые 6 часов

### 3. Cron задачи

Автоматически настроены:
- Проверка актуальности: каждые 5 минут (в health-check)
- Автоматическая пересборка: каждые 6 часов
- Восстановление: каждые 15 минут (в auto-recovery)

## Использование

### Ручная проверка актуальности
```bash
/home/ubuntu/scripts/check-image-freshness.sh
```

### Ручная пересборка фронтенда
```bash
/home/ubuntu/scripts/rebuild-frontend.sh
```

### Принудительная пересборка
```bash
/home/ubuntu/scripts/rebuild-frontend.sh --force
```

### Автоматическая пересборка всех устаревших образов
```bash
/home/ubuntu/scripts/auto-rebuild.sh
```

## Логи

- `/home/ubuntu/logs/health.log` - результаты health checks
- `/home/ubuntu/logs/auto-rebuild.log` - логи автоматической пересборки
- `/home/ubuntu/logs/recovery.log` - логи восстановления

## Предотвращение проблем

1. **Автоматическая проверка** - система автоматически проверяет актуальность образов
2. **Автоматическая пересборка** - устаревшие образы пересобираются автоматически
3. **Мониторинг** - health checks включают проверку версий
4. **Логирование** - все операции записываются в логи

## Рекомендации

1. **После изменений кода**: Запустите `rebuild-frontend.sh` или `auto-rebuild.sh`
2. **Перед деплоем**: Проверьте актуальность образов через `check-image-freshness.sh`
3. **Мониторинг**: Регулярно проверяйте логи в `/home/ubuntu/logs/`

## Технические детали

### Как определяется актуальность

1. Получается дата создания образа из Docker
2. Находится последняя дата изменения файлов исходного кода
3. Сравниваются даты - если код новее образа, требуется пересборка

### Процесс пересборки

1. Остановка контейнера
2. Удаление старого образа
3. Сборка нового образа (без кэша)
4. Запуск нового контейнера
5. Проверка работоспособности


