# ‚úÖ Redis Pub/Sub Implementation –¥–ª—è –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

## üéØ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ Redis Pub/Sub –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ API-—Å–µ—Ä–≤–µ—Ä–∞ –∑–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º –Ω–∞–≥—Ä—É–∑–∫–∏, –∏ –≤—Å–µ –æ–Ω–∏ –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ Redis.

## üìã –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. RedisPubSubService
**–§–∞–π–ª**: `backend/internal/services/redis_pubsub_service.go`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ `PublishTask()` - –ø—É–±–ª–∏–∫—É–µ—Ç –∑–∞–¥–∞—á—É –≤ Redis –∫–∞–Ω–∞–ª `gstd_tasks_channel`
- ‚úÖ `Subscribe()` - –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–Ω–∞–ª –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞–Ω–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ Graceful shutdown —á–µ—Ä–µ–∑ `Stop()`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```json
{
  "task_id": "uuid",
  "task_type": "AI_INFERENCE",
  "status": "pending",
  "payload": {
    "requester_address": "...",
    "labor_compensation": 0.5,
    "gravity_score": 1.2,
    "min_trust_score": 0.1,
    ...
  },
  "timestamp": 1234567890
}
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ TaskService
**–§–∞–π–ª**: `backend/internal/services/task_service.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `redisPubSub *RedisPubSubService` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- ‚úÖ `BroadcastTaskToHub()` —Ç–µ–ø–µ—Ä—å –ø—É–±–ª–∏–∫—É–µ—Ç –≤ Redis Pub/Sub –ø–µ—Ä–µ–¥ –ª–æ–∫–∞–ª—å–Ω—ã–º broadcast
- ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ `pending` –∏ `queued`

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ WSHub
**–§–∞–π–ª**: `backend/internal/api/ws_handler.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `SetRedisPubSub()` –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ Redis –∫–∞–Ω–∞–ª
- ‚úÖ `handleRedisMessages()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Redis
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á–∏ –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º WebSocket –∫–ª–∏–µ–Ω—Ç–∞–º
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É (—Ç–æ–ª—å–∫–æ `pending` –∏ `queued`)

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ TaskPaymentService
**–§–∞–π–ª**: `backend/internal/services/task_payment_service.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ `MarkTaskAsPaid()` —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç broadcast –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ `queued`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `SetTaskService()` –¥–ª—è —Å–≤—è–∑–∏ —Å TaskService

### 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ main.go
**–§–∞–π–ª**: `backend/main.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ WSHub –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ Redis Pub/Sub –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- ‚úÖ TaskPaymentService —Å–≤—è–∑–∞–Ω —Å TaskService –¥–ª—è broadcast

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ Server A

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É** ‚Üí `POST /api/v1/tasks/create`
2. **TaskPaymentService** —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending_payment`
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç** ‚Üí PaymentWatcher –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
4. **MarkTaskAsPaid()** –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `queued`
5. **BroadcastTaskToHub()** –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
   - ‚úÖ –ü—É–±–ª–∏–∫—É–µ—Ç –≤ Redis Pub/Sub –∫–∞–Ω–∞–ª `gstd_tasks_channel`
   - ‚úÖ Broadcast –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π WSHub (Server A)

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ Server B

1. **WSHub –Ω–∞ Server B** –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ Redis –∫–∞–Ω–∞–ª
2. **Redis Pub/Sub** –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ `handleRedisMessages()`
3. **WSHub** –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ `models.Task`
4. **BroadcastTask()** —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º WebSocket –∫–ª–∏–µ–Ω—Ç–∞–º –Ω–∞ Server B

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ **–≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –í–æ—Ä–∫–µ—Ä—ã –Ω–∞ –ª—é–±–æ–º —Å–µ—Ä–≤–µ—Ä–µ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á—É
- ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –∑–∞–¥–∞—á –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å N —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ API-—Å–µ—Ä–≤–µ—Ä–∞
- –í—Å–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ Redis
- Load balancer –º–æ–∂–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã

### 2. –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
- –ï—Å–ª–∏ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä —É–ø–∞–¥–µ—Ç, –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- Redis —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

### 3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (Redis Pub/Sub –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –¥–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π

### 4. Investor Confidence
- ‚úÖ "–ê —á—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –ø—Ä–∏–¥–µ—Ç 100,000 –≤–æ—Ä–∫–µ—Ä–æ–≤?"
- ‚úÖ **–û—Ç–≤–µ—Ç**: "–ù–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞ —á–µ—Ä–µ–∑ Redis Pub/Sub —à–∏–Ω—É. –ú—ã –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∑–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º –Ω–∞–≥—Ä—É–∑–∫–∏."

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Redis –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
–£–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `docker-compose.yml`:
```yaml
redis:
  image: redis:7-alpine
  ports:
    - "6379:6379"
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis: `docker-compose up redis`
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å 2 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ backend –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ä—Ç–∞—Ö:
   ```bash
   PORT=8080 go run main.go  # Server A
   PORT=8081 go run main.go  # Server B
   ```
3. –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ Server A
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–∞ Server B —á–µ—Ä–µ–∑ WebSocket

### Production —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∑–∞ nginx/HAProxy
2. –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ - –≤—Å–µ –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á—É

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Ä–∞–±–æ—Ç–µ –≤—ã —É–≤–∏–¥–∏—Ç–µ:
```
‚úÖ Published task abc-123 to Redis channel gstd_tasks_channel
‚úÖ WSHub subscribed to Redis Pub/Sub channel: gstd_tasks_channel
üì• Received task from Redis Pub/Sub: abc-123 (status: queued)
```

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Production

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ì–û–¢–û–í–û –ö PRODUCTION**

- ‚úÖ Redis Pub/Sub —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ Graceful shutdown
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–û—Ü–µ–Ω–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏**: **10/10** üéâ

---

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 2025-01-07  
**–í–µ—Ä—Å–∏—è**: 1.0
