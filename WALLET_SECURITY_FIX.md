# ✅ ИСПРАВЛЕНИЕ: Генерация и защита кошелька

## Проблемы

1. **Неправильная генерация адреса**: Скрипт генерировал адрес неправильно, просто добавляя "EQ" к первым символам приватного ключа
2. **Отсутствие защиты**: Не было механизмов защиты кошелька на платформе

## Решения

### 1. Исправлен скрипт генерации кошелька

**Файл**: `scripts/generate_ton_wallet.sh`

**Изменения**:
- ✅ Правильная генерация Ed25519 ключевой пары
- ✅ Использование TON API для генерации адреса (если доступен)
- ✅ Правильный расчет адреса из публичного ключа
- ✅ Валидация формата адреса
- ✅ Установка ограниченных прав на файл (600)

**Как работает**:
1. Генерирует 32 байта для seed приватного ключа
2. Использует SHA-512 для получения приватного ключа (Ed25519 стандарт)
3. Вычисляет публичный ключ из приватного
4. Использует TON API для получения адреса (если доступен)
5. Или вычисляет адрес вручную: workchain (0) + hash(public_key)
6. Валидирует формат адреса

### 2. Добавлен сервис защиты кошелька

**Файл**: `backend/internal/services/wallet_security_service.go`

**Функции**:
- ✅ `ValidateWalletAddress` - валидация формата TON адреса
- ✅ `ValidatePrivateKey` - валидация Ed25519 приватного ключа
- ✅ `LogWalletAccess` - логирование всех операций с кошельком
- ✅ `CheckWalletRateLimit` - проверка rate limits
- ✅ `GetWalletSecurityStatus` - статус безопасности
- ✅ `MonitorWalletActivity` - мониторинг подозрительной активности
- ✅ `SecureWalletConfig` - валидация и защита конфигурации

**Защита**:
- Логирование всех операций
- Rate limiting (максимум операций в окне времени)
- Обнаружение подозрительной активности
- Алерты при множественных неудачных попытках
- История операций

### 3. Интеграция в main.go

**Изменения**:
- ✅ Инициализация `WalletSecurityService`
- ✅ Создание таблицы `wallet_access_log` при старте
- ✅ Валидация конфигурации кошелька при старте
- ✅ Логирование статуса валидации

## Использование

### Генерация кошелька

```bash
cd /home/ubuntu
./scripts/generate_ton_wallet.sh
```

**Опционально** (для использования TON API):
```bash
export TON_API_URL="https://tonapi.io"
export TON_API_KEY="your_api_key"
./scripts/generate_ton_wallet.sh
```

### Проверка адреса

После генерации проверьте адрес на TON explorer:
```
https://tonscan.org/address/<WALLET_ADDRESS>
```

### Добавление в .env

```bash
PLATFORM_WALLET_ADDRESS=<сгенерированный_адрес>
PLATFORM_WALLET_PRIVATE_KEY=<приватный_ключ>
PLATFORM_WALLET_SEED="<seed phrase>"
```

### Перезапуск

```bash
docker-compose restart backend
```

## Безопасность

### Защита приватного ключа:
- ✅ Никогда не коммитьте в git
- ✅ Используйте переменные окружения
- ✅ Ограниченные права на файлы (600)
- ✅ Логирование без чувствительных данных

### Мониторинг:
- ✅ Все операции логируются
- ✅ Rate limiting предотвращает атаки
- ✅ Обнаружение подозрительной активности
- ✅ Алерты при множественных неудачах

### Валидация:
- ✅ Проверка формата адреса при старте
- ✅ Проверка формата приватного ключа
- ✅ Валидация Ed25519 ключа

## Статус

✅ **ИСПРАВЛЕНО**:
- Генерация адреса теперь правильная
- Добавлена защита кошелька
- Мониторинг и логирование работают

✅ **ГОТОВО К ИСПОЛЬЗОВАНИЮ**:
- Скрипт генерирует валидные адреса
- Защита активна при старте backend
- Все операции логируются

