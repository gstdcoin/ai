name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine Server Config
        id: server_config
        run: |
          if [ -n "${{ secrets.SERVER_IP }}" ]; then
             echo "IP=${{ secrets.SERVER_IP }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.SSH_HOST }}" ]; then
             echo "IP=${{ secrets.SSH_HOST }}" >> $GITHUB_OUTPUT
          else
             echo "::error::server ip secret incorrect"
             exit 1
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}
            ${{ secrets.SSH_KEY }}
      
      - name: Add to Known Hosts
        env:
          SERVER_IP: ${{ steps.server_config.outputs.IP }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H -t rsa,ed25519 "$SERVER_IP" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy
        env:
          SERVER_IP: ${{ steps.server_config.outputs.IP }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set -e
          
          # Prepare Environment File Securely
          cat << EOF > env_update_script.sh
            export DB_PASSWORD='${DB_PASSWORD}'
          EOF
          
          scp -o StrictHostKeyChecking=no env_update_script.sh ${SSH_USER}@${SERVER_IP}:/tmp/deploy_env_vars.sh
          
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} "bash -s" << 'REMOTE_EXEC'
            set -e
            
            # --- 1. SETUP & CONFIG ---
            source /tmp/deploy_env_vars.sh
            rm -f /tmp/deploy_env_vars.sh
            
            TARGET_DIR="/home/ubuntu"
            cd $TARGET_DIR || { echo "‚ùå Directory not found"; exit 1; }
            
            # Docker Command Detection
            DOCKER_CMD="docker"
            if ! docker ps >/dev/null 2>&1; then
                if sudo docker ps >/dev/null 2>&1; then
                    DOCKER_CMD="sudo docker"
                else
                    echo "‚ùå Docker permission error"
                    exit 1
                fi
            fi
            
            echo "üì• Syncing Code (Immortal Mode)..."
            # 2. HARD SYNC (The "Reset" Strategy)
            git fetch --all
            # Backup .env safely
            cp .env .env.backup 2>/dev/null || true
            git reset --hard origin/main
            git clean -fd
            mv .env.backup .env 2>/dev/null || true
            
            echo "üîê Updating Secrets..."
            if [ ! -f .env ]; then
                echo "DB_PASSWORD='${DB_PASSWORD}'" > .env
            else
                sed -i '/^DB_PASSWORD=/d' .env
                echo "DB_PASSWORD='${DB_PASSWORD}'" >> .env
            fi
            
            # Ensure prod config is active
            ln -sf docker-compose.prod.yml docker-compose.yml
            
            echo "üïµÔ∏è  Config Check..."
            # 3. CONFIG VALIDATION
            if ! $DOCKER_CMD compose config > /dev/null; then
                echo "‚ùå Invalid Docker Compose Configuration"
                exit 1
            fi
            
            echo "üöÄ Deployment (V2 Plugin)..."
            # 4. STARTUP (V2 Logic)
            $DOCKER_CMD compose up -d --build --remove-orphans
            
            echo "üßπ Cleanup..."
            # 5. GARBAGE COLLECTION
            $DOCKER_CMD image prune -f
            
            echo "‚úÖ Health Check..."
            # 6. VERIFICATION
            sleep 15
            # We assume containers are marked 'healthy' by docker-compose healthchecks
            if $DOCKER_CMD compose ps | grep -q "healthy"; then
               echo "DEPLOY SUCCESS: Systems are healthy! üöÄ"
               $DOCKER_CMD compose ps
            else
               echo "‚ö†Ô∏è  Health Check Pending or Failed. Checking API..."
               # Fallback: Try hitting the API internally
               if $DOCKER_CMD compose exec -T ubuntu-backend-blue-1 wget -qO- http://localhost:8080/api/v1/health | grep -q "healthy"; then
                   echo "API is Responsive via internal check."
               else
                   echo "‚ùå DEPLOY FAILED: System unhealthy."
                   $DOCKER_CMD compose logs --tail=20
                   exit 1
               fi
            fi
            
          REMOTE_EXEC
