name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check SSH secrets
        run: |
          # Robust Secret Checking with Fallbacks
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚úÖ SSH_PRIVATE_KEY is set"
            echo "SSH_PRIVATE_KEY_ACTUAL=${{ secrets.SSH_PRIVATE_KEY }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.SSH_KEY }}" ]; then
            echo "‚ö†Ô∏è Using SSH_KEY fallback"
            echo "SSH_PRIVATE_KEY_ACTUAL=${{ secrets.SSH_KEY }}" >> $GITHUB_ENV
          else
            echo "‚ùå No SSH Key found (SSH_PRIVATE_KEY or SSH_KEY)"
            exit 1
          fi
          
          if [ -n "${{ secrets.SERVER_IP }}" ]; then
             echo "‚úÖ SERVER_IP is set"
             echo "SERVER_IP_ACTUAL=${{ secrets.SERVER_IP }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.SSH_HOST }}" ]; then
             echo "‚ö†Ô∏è Using SSH_HOST fallback"
             echo "SERVER_IP_ACTUAL=${{ secrets.SSH_HOST }}" >> $GITHUB_ENV
          else
             echo "‚ùå No Server IP found (SERVER_IP or SSH_HOST)"
             exit 1
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SSH_PRIVATE_KEY_ACTUAL }}
      
      - name: Deploy to server
        env:
          SERVER_IP: ${{ env.SERVER_IP_ACTUAL }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set -e
          echo "üöÄ Starting Deployment..."
          
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} "DB_PASSWORD='${DB_PASSWORD}' bash -s" << 'DEPLOY_SCRIPT'
            set -e
            
            # 1. Permission Check & Sudo Config
            SUDO=""
            if ! docker ps >/dev/null 2>&1; then
                if sudo docker ps >/dev/null 2>&1; then
                    SUDO="sudo"
                    echo "‚ö†Ô∏è  Using sudo for Docker commands"
                else
                    echo "‚ùå Docker permission denied (even with sudo)"
                    exit 1
                fi
            fi
            
            # 2. Directory Safety
            cd /home/ubuntu || { echo "‚ùå /home/ubuntu not found"; exit 1; }
            
            # 3. Code Sync
            echo "üì• Syncing code..."
            git stash || true
            git pull origin main || git pull origin master || { echo "‚ùå Git pull failed"; exit 1; }
            
            # 4. Env Config
            echo "üîê Updating .env..."
            if [ -f .env ]; then
                sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=${DB_PASSWORD}|" .env || echo "DB_PASSWORD=${DB_PASSWORD}" >> .env
            else
                echo "DB_PASSWORD=${DB_PASSWORD}" > .env
            fi
            ln -sf docker-compose.prod.yml docker-compose.yml
            
            # 5. Cleanup & Restart (The Fix)
            echo "‚ôªÔ∏è  Restarting services..."
            $SUDO docker compose down --remove-orphans
            
            # Clean orphans forcefully
            $SUDO docker rm -f gstd_frontend gstd_backend gstd_gateway 2>/dev/null || true
            
            # Prune before build if space is low (optional smart check, but we do it always for cleanliness)
            echo "üßπ Pruning old images..."
            $SUDO docker image prune -f
            
            # Build and Up
            echo "üöÄ Booting up..."
            $SUDO docker compose up -d --build --remove-orphans
            
            # 6. Verification
            echo "‚è≥ Verifying health..."
            sleep 10
            $SUDO docker compose ps
            
            echo "‚úÖ DEPLOY SUCCESS"
          DEPLOY_SCRIPT
