name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check SSH secrets
        run: |
          if [ -z "${{ secrets.SSH_KEY }}" ]; then
            echo "‚ùå SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "‚ùå SSH_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "‚ùå SSH_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
            echo "‚ùå DB_PASSWORD secret is not set"
            exit 1
          fi
          echo "‚úÖ All secrets are configured"
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      
      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set -e
          echo "üöÄ Starting deployment to production server..."
          
          # Deploy script that runs on the server
          # Pass DB_PASSWORD as environment variable through SSH
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} "DB_PASSWORD='${DB_PASSWORD}' bash -s" << 'DEPLOY_SCRIPT'
            set -e
            
            echo "üìÅ Changing to project directory..."
            cd /home/ubuntu || cd /home/${USER} || { echo "‚ùå Project directory not found"; exit 1; }
            
            echo "üíæ Stashing local changes (if any)..."
            git stash || echo "‚ö†Ô∏è  No local changes to stash"
            
            echo "üì• Pulling latest code from repository..."
            git pull origin main || git pull origin master || { echo "‚ùå Git pull failed"; exit 1; }
            
            echo "üîê Setting up database password in environment..."
            # Create or update .env file with DB_PASSWORD
            if [ ! -f .env ]; then
              echo "DB_PASSWORD=${DB_PASSWORD}" > .env
              echo "‚úÖ Created .env file"
            else
              # Update DB_PASSWORD in existing .env file
              if grep -q "^DB_PASSWORD=" .env; then
                sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=${DB_PASSWORD}|" .env
              else
                echo "DB_PASSWORD=${DB_PASSWORD}" >> .env
              fi
              echo "‚úÖ Updated DB_PASSWORD in .env file"
            fi
            
            echo "üê≥ Stopping existing containers..."
            docker-compose down || echo "‚ö†Ô∏è  No containers to stop"
            
            echo "üîÑ Rebuilding and starting containers..."
            docker-compose up -d --build --remove-orphans
            
            echo "‚è≥ Waiting for services to start..."
            sleep 10
            
            echo "üìä Checking container status..."
            docker-compose ps
            
            echo "‚úÖ Deployment completed successfully!"
          DEPLOY_SCRIPT
      
      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          echo "üîç Verifying deployment..."
          ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} << 'VERIFY_SCRIPT'
            cd /home/ubuntu || cd /home/${USER}
            echo "üìä Container status:"
            docker-compose ps
            echo ""
            echo "üìã Recent logs (last 20 lines):"
            docker-compose logs --tail=20 || true
          VERIFY_SCRIPT
