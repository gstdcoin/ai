version: '3.8'

services:
  watchtower:
    image: containrrr/watchtower
    container_name: gstd_watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_API_VERSION=1.45
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=telegram://8306755226:AAEfG2-BZ1Xo9hPex7-igz_WzHEscJOOk-U@telegram?channels=5700385228
    command: --interval 3600 --cleanup --label-enable
    restart: always
    networks:
      - ubuntu_gstd_network

  vector:
    image: timberio/vector:latest-alpine
    container_name: gstd_vector
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./vector/vector.toml:/etc/vector/vector.toml:ro
    depends_on:
      - n8n
    restart: always
    networks:
      - ubuntu_gstd_network

  ollama:
    image: ollama/ollama:latest
    container_name: gstd_ollama
    volumes:
      - ollama_data:/root/.ollama
    restart: always
    deploy:
      resources:
        limits:
          memory: 6G
    networks:
      - ubuntu_gstd_network

  bot:
    image: golang:1.24
    container_name: gstd_bot
    working_dir: /app
    volumes:
      - ./bot:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - ../backend:/home/ubuntu/backend
      - ./proposals:/home/ubuntu/autonomy/proposals
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-8306755226:AAEfG2-BZ1Xo9hPex7-igz_WzHEscJOOk-U}
      - OLLAMA_HOST=https://api.ollama.com
      - OLLAMA_API_KEY=3010cb48437e419fa97fa354f809dae8.NV9cjek-htbaddBb9wpU3MH9
    command: sh -c "go mod tidy && go run main.go"
    restart: always
    networks:
      - ubuntu_gstd_network

  n8n:
    image: n8nio/n8n:latest
    container_name: gstd_n8n
    restart: always
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=n8n.gstdtoken.com
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://n8n.gstdtoken.com/
      - OLLAMA_HOST=https://api.ollama.com
      - OLLAMA_API_KEY=3010cb48437e419fa97fa354f809dae8.NV9cjek-htbaddBb9wpU3MH9
    volumes:
      - n8n_data:/home/node/.n8n
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/ubuntu/backend:/data/backend:ro
      - /home/ubuntu/autonomy/proposals:/data/proposals
    networks:
      - ubuntu_gstd_network

networks:
  ubuntu_gstd_network:
    external: true

volumes:
  n8n_data:
  ollama_data:
