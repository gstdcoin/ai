# ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ CI/CD Pipeline

## ÐÐ°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹

### 1. âŒ ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ build-args
**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°**: Ð’ ÑÑ‚Ñ€Ð¾ÐºÐµ 201 Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Ð´Ð»Ñ ÑƒÑÐ»Ð¾Ð²Ð½Ð¾Ð³Ð¾ build-args
```yaml
build-args: |
  ${{ matrix.component == 'frontend' && 'NEXT_PUBLIC_API_URL=https://app.gstdtoken.com' || '' }}
```

**Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ**: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¼Ð½Ð¾Ð³Ð¾ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
```yaml
build-args: |
  ${{ matrix.component == 'frontend' && 'NEXT_PUBLIC_API_URL=https://app.gstdtoken.com' || '' }}
```

### 2. âŒ ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ GitHub Actions Ð² heredoc Ñ Ð¾Ð´Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¼Ð¸ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ°Ð¼Ð¸
**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°**: Ð’ ÑÑ‚Ñ€Ð¾ÐºÐ°Ñ… 240-303 Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ heredoc Ñ Ð¾Ð´Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¼Ð¸ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ°Ð¼Ð¸ (`'DEPLOY_SCRIPT'`), Ñ‡Ñ‚Ð¾ Ð½Ðµ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐ»Ð¾ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ GitHub Actions Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°.

**Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ**: 
- Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½ heredoc Ð½Ð° Ð±ÐµÐ· ÐºÐ°Ð²Ñ‹Ñ‡ÐµÐº (`DEPLOY_SCRIPT`) Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ `REGISTRY` Ð¸ `IMAGE_NAME` Ð² step `Deploy to server`
- Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ñ‹ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ñ `${{ env.REGISTRY }}` Ð½Ð° `${REGISTRY}`

**Ð‘Ñ‹Ð»Ð¾:**
```yaml
cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
  ...
  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:main
  ...
DEPLOY_SCRIPT
```

**Ð¡Ñ‚Ð°Ð»Ð¾:**
```yaml
env:
  REGISTRY: ${{ env.REGISTRY }}
  IMAGE_NAME: ${{ env.IMAGE_NAME }}
run: |
  cat > /tmp/deploy.sh << DEPLOY_SCRIPT
    ...
    docker pull ${REGISTRY}/${IMAGE_NAME}-backend:main
    ...
  DEPLOY_SCRIPT
```

### 3. âŒ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ secrets Ð²Ð½ÑƒÑ‚Ñ€Ð¸ heredoc
**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°**: `${{ secrets.SSH_USER }}` Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ heredoc Ñ Ð¾Ð´Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¼Ð¸ ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ°Ð¼Ð¸, Ñ‡Ñ‚Ð¾ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð»Ð¾.

**Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ**: Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ `${SSH_USER}`, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð² env ÑÐµÐºÑ†Ð¸Ð¸ step.

## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹

âœ… YAML ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½ - ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½
âœ… Ð’ÑÐµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð»ÑÑŽÑ‚ÑÑ
âœ… Heredoc Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…

## Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸

1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ workflow Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð² GitHub Actions
2. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹:
   - `SSH_KEY`
   - `SSH_HOST`
   - `SSH_USER`
   - `SSH_PORT` (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
   - `SSH_KNOWN_HOSTS`
3. ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· GitHub Actions

## Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹

Ð•ÑÐ»Ð¸ CI/CD Ð²ÑÐµ ÐµÑ‰Ðµ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:

1. **Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ GitHub**: Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹
2. **SSH ÐºÐ»ÑŽÑ‡Ð¸**: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² `authorized_keys` Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
3. **ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°**: Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´
4. **Docker**: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ Docker Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
5. **Git**: Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð´Ð»Ñ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

## Ð›Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸

Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÑŽÑ‚ÑÑ, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð² GitHub Actions:
- ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² **Actions** â†’ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ workflow run
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ step
- ÐžÑÐ¾Ð±Ð¾Ðµ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ Ð½Ð° step "Deploy to server"

## ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSH ÐºÐ»ÑŽÑ‡Ð°
cat ~/.ssh/authorized_keys | grep github-actions

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker
docker ps
docker-compose -f docker-compose.prod.yml ps

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Git
cd /home/ubuntu && git status

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð²
ls -la scripts/deploy.sh
chmod +x scripts/deploy.sh
```
